# Supabase RLS –ê–ª–¥–∞–∞–≥ –ó–∞—Å–∞—Ö –ó–∞–∞–≤–∞—Ä

## üö® –ê—Å—É—É–¥–∞–ª

Supabase Security Advisor –Ω—å **25 –∞–ª–¥–∞–∞** –∏–ª—Ä“Ø“Ø–ª—Å—ç–Ω:
- Public schema-–∏–π–Ω —Ö“Ø—Å–Ω—ç–≥—Ç“Ø“Ø–¥—ç–¥ **Row Level Security (RLS)** –∏–¥—ç–≤—Ö–≥“Ø–π –±–∞–π–Ω–∞
- –≠–Ω—ç –Ω—å –∞—é—É–ª–≥“Ø–π –±–∞–π–¥–ª—ã–Ω –∞–ª–¥–∞–∞

## ‚úÖ –®–∏–π–¥—ç–ª

### –ê–ª—Ö–∞–º 1: Supabase Dashboard —Ä—É—É –æ—Ä–æ—Ö

1. [Supabase Dashboard](https://app.supabase.com) —Ä—É—É –Ω—ç–≤—Ç—Ä—ç—Ö
2. –¢–∞–Ω—ã **AGENTBUY** project-–∏–π–≥ —Å–æ–Ω–≥–æ—Ö
3. –ó“Ø“Ø–Ω —Ç–∞–ª—ã–Ω —Ü—ç—Å–Ω—ç—ç—Å **SQL Editor** —Å–æ–Ω–≥–æ—Ö

### –ê–ª—Ö–∞–º 2: SQL Script –∞–∂–∏–ª–ª—É—É–ª–∞—Ö

**–°–æ–Ω–≥–æ–ª—Ç A: RLS + Policy (–ó”©–≤–ª”©–º–∂–ª”©—Ö)** ‚úÖ

1. `backend/prisma/migrations/enable_rls_with_policies.sql` —Ñ–∞–π–ª—ã–≥ –Ω—ç—ç—Ö
2. –ë“Ø—Ö –∞–≥—É—É–ª–≥—ã–≥ —Ö—É—É–ª–∞—Ö (Ctrl+A, Ctrl+C)
3. Supabase SQL Editor –¥—ç—ç—Ä paste —Ö–∏–π—Ö
4. **RUN** —Ç–æ–≤—á –¥–∞—Ä–Ω–∞

–≠–Ω—ç –Ω—å:
- ‚úÖ –ë“Ø—Ö —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ RLS –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª–Ω—ç
- ‚úÖ Service role-–¥ –±“Ø—Ö —ç—Ä—Ö ”©–≥”©—Ö policy “Ø“Ø—Å–≥—ç–Ω—ç
- ‚úÖ –¢–∞–Ω—ã Node.js backend (Prisma) –∞–∂–∏–ª–ª–∞—Ö–∞–¥ —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π

**–°–æ–Ω–≥–æ–ª—Ç B: –ó”©–≤—Ö”©–Ω RLS (–≠–Ω–≥–∏–π–Ω)**

–•—ç—Ä—ç–≤ —Ç–∞ –∑”©–≤—Ö”©–Ω RLS –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö —Ö“Ø—Å–≤—ç–ª:
1. `backend/prisma/migrations/enable_rls.sql` —Ñ–∞–π–ª—ã–≥ –∞—à–∏–≥–ª–∞–Ω–∞
2. –î–∞—Ä–∞–∞ –Ω—å policy “Ø“Ø—Å–≥—ç—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π (—ç—Å –±”©–≥”©”©—Å query —Ö–∏–π—Ö –±–æ–ª–æ–º–∂–≥“Ø–π)

### –ê–ª—Ö–∞–º 3: –®–∞–ª–≥–∞—Ö

1. SQL Editor –¥—ç—ç—Ä –∞–∂–∏–ª–ª—É—É–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ **"Success"** –≥—ç—Å—ç–Ω –º–µ—Å—Å–µ–∂ —Ö–∞—Ä–∞–≥–¥–∞—Ö —ë—Å—Ç–æ–π
2. Supabase Dashboard ‚Üí **Security Advisor** —Ä—É—É –±—É—Ü–∞—Ö
3. **"Rerun linter"** —Ç–æ–≤—á –¥–∞—Ä–Ω–∞
4. –ê–ª–¥–∞–∞–Ω—É—É–¥ –∞—Ä–∏–ª—Å–∞–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞

## üìã –•“Ø—Å–Ω—ç–≥—Ç“Ø“Ø–¥ (RLS –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö)

–î–∞—Ä–∞–∞—Ö —Ö“Ø—Å–Ω—ç–≥—Ç“Ø“Ø–¥—ç–¥ RLS –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª–Ω—ç:
- ‚úÖ `settings`
- ‚úÖ `cargos`
- ‚úÖ `users`
- ‚úÖ `orders`
- ‚úÖ `order_items`
- ‚úÖ `order_locks`
- ‚úÖ `order_pricings`
- ‚úÖ `order_payments`
- ‚úÖ `order_trackings`
- ‚úÖ `order_reports`
- ‚úÖ `order_report_items`
- ‚úÖ `order_report_pricings`

**–ê–Ω—Ö–∞–∞—Ä:** `_prisma_migrations` —Ö“Ø—Å–Ω—ç–≥—Ç –Ω—å Prisma system table —Ç—É–ª RLS –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π.

## üîí Policy-–∏–π–Ω —Ç–∞–π–ª–±–∞—Ä

–û–¥–æ–æ–≥–∏–π–Ω policy-—É—É–¥ –Ω—å `service_role`-–¥ –±“Ø—Ö —ç—Ä—Ö ”©–≥–¥”©–≥. –≠–Ω—ç –Ω—å:
- ‚úÖ –¢–∞–Ω—ã Node.js backend (Prisma) –∞–∂–∏–ª–ª–∞—Ö–∞–¥ —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π
- ‚úÖ Supabase Security Advisor-–∏–π–Ω –∞–ª–¥–∞–∞–≥ –∞—Ä–∏–ª–≥–∞–Ω–∞
- ‚úÖ PostgREST API access-–¥ –∑–æ—Ä–∏—É–ª—Å–∞–Ω

## ‚ö†Ô∏è –ê–Ω—Ö–∞–∞—Ä–∞—Ö –∑“Ø–π–ª—Å

1. **DATABASE_URL —à–∞–ª–≥–∞—Ö**: –•—ç—Ä—ç–≤ —Ç–∞–Ω—ã `.env` —Ñ–∞–π–ª–¥ `service_role` key –±–∞–π–≥–∞–∞ –±–æ–ª Prisma –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä RLS-–∏–π–≥ bypass —Ö–∏–π—Ö –±–æ–ª–Ω–æ. Policy-—É—É–¥ –Ω—å PostgREST API-–¥ –∑–æ—Ä–∏—É–ª–∞–≥–¥—Å–∞–Ω.

2. **Backend —Ç–µ—Å—Ç–ª—ç—Ö**: SQL –∞–∂–∏–ª–ª—É—É–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ backend-–∏–π–≥ –¥–∞—Ö–∏–Ω —ç—Ö–ª“Ø“Ø–ª–∂, –±“Ø—Ö —Ñ—É–Ω–∫—Ü –∑”©–≤ –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞.

3. **Client-side access**: –•—ç—Ä—ç–≤ —Ç–∞ Supabase client-side authentication –∞—à–∏–≥–ª–∞—Ö—ã–≥ —Ö“Ø—Å–≤—ç–ª –Ω—ç–º—ç–ª—Ç policy “Ø“Ø—Å–≥—ç—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π (–∂–∏—à—ç—ç: user-—É—É–¥ –∑”©–≤—Ö”©–Ω ”©”©—Ä—Å–¥–∏–π–Ω ”©–≥”©–≥–¥”©–ª —Ö–∞—Ä–∞—Ö).

## üÜò –ê—Å—É—É–¥–∞–ª –≥–∞—Ä–≤–∞–ª

–•—ç—Ä—ç–≤ SQL –∞–∂–∏–ª–ª—É—É–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ backend –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π –±–æ–ª:

1. Policy-—É—É–¥ –∑”©–≤ “Ø“Ø—Å–≥—ç–≥–¥—Å—ç–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö:
   ```sql
   SELECT * FROM pg_policies WHERE schemaname = 'public';
   ```

2. RLS –∏–¥—ç–≤—Ö—Ç—ç–π —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö:
   ```sql
   SELECT tablename, rowsecurity 
   FROM pg_tables 
   WHERE schemaname = 'public' AND rowsecurity = true;
   ```

3. –•—ç—Ä—ç–≤ —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π –±–æ–ª policy-—É—É–¥—ã–≥ —É—Å—Ç–≥–∞—Ö:
   ```sql
   DROP POLICY IF EXISTS "service_role_*" ON "public"."*";
   ```

## ‚úÖ –î–∞—Ä–∞–∞–≥–∏–π–Ω –∞–ª—Ö–º—É—É–¥

1. ‚úÖ RLS –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö
2. ‚úÖ Policy “Ø“Ø—Å–≥—ç—Ö
3. ‚úÖ Backend —Ç–µ—Å—Ç–ª—ç—Ö
4. ‚úÖ Security Advisor –¥–∞—Ö–∏–Ω —à–∞–ª–≥–∞—Ö
5. ‚è≠Ô∏è –•—ç—Ä—ç–≤ —Ö—ç—Ä—ç–≥—Ç—ç–π –±–æ–ª client-side policy –Ω—ç–º—ç—Ö

